# ComfyUI-TuZi-Flux-Kontext 开发任务清单 (TODO)

## 项目概述
基于 Flux-Kontext-Pro API 开发 ComfyUI 自定义节点，支持AI图像生成功能。

## 开发任务清单

### 阶段一：项目基础设置
- [ ] **1.1 项目结构创建**
  - [ ] 创建 `__init__.py` 文件（ComfyUI节点注册入口）
  - [ ] 创建 `nodes.py` 文件（节点实现主文件）
  - [ ] 创建 `api_client.py` 文件（API客户端封装）
  - [ ] 创建 `utils.py` 文件（工具函数）
  - [ ] 创建 `config.py` 文件（配置管理）
  - [ ] 创建 `requirements.txt` 文件（依赖管理）
  - [ ] 创建 `README.md` 文件（项目说明）

- [ ] **1.2 依赖配置**
  - [ ] 在 `requirements.txt` 中添加必要依赖：
    - [ ] `requests` - HTTP请求库
    - [ ] `pillow` - 图像处理库
    - [ ] `numpy` - 数值计算库
    - [ ] `torch` - PyTorch（ComfyUI依赖）
    - [ ] `torchvision` - 图像处理工具

### 阶段二：API客户端开发
- [ ] **2.1 基础API客户端类 (`api_client.py`)**
  - [ ] 创建 `FluxKontextAPI` 类
  - [ ] 实现初始化方法，支持API密钥配置
  - [ ] 实现基础HTTP请求方法
  - [ ] 添加请求头设置（Authorization, Content-Type等）
  - [ ] 实现错误处理和重试机制

- [ ] **2.2 标准API接口实现**
  - [ ] 实现 `generate_image()` 方法
    - [ ] 支持所有必填参数：model, prompt
    - [ ] 支持所有可选参数：
      - [ ] `seed` - 随机种子
      - [ ] `aspect_ratio` - 宽高比
      - [ ] `output_format` - 输出格式
      - [ ] `safety_tolerance` - 安全容忍度
      - [ ] `prompt_upsampling` - 提示上采样
      - [ ] `webhook_url` - Webhook通知URL
      - [ ] `webhook_secret` - Webhook签名密钥
  - [ ] 实现响应解析和验证
  - [ ] 添加图片下载功能
  - [ ] 实现Base64图片处理（为未来input_image功能预留）

- [ ] **2.3 Chat格式API接口实现（可选）**
  - [ ] 实现 `generate_image_chat()` 方法
  - [ ] 支持流式输出处理
  - [ ] 实现消息格式构建

### 阶段三：ComfyUI节点开发
- [ ] **3.1 主节点类开发 (`nodes.py`)**
  - [ ] 创建 `FluxKontextNode` 类
  - [ ] 定义节点分类和显示名称
  - [ ] 实现 `INPUT_TYPES` 类方法：
    - [ ] `prompt` - 文本输入（支持多行）
    - [ ] `api_key` - API密钥输入
    - [ ] `seed` - 整数输入（可选）
    - [ ] `aspect_ratio` - 下拉选择（21:9, 16:9, 4:3, 1:1, 3:4, 9:16, 9:21）
    - [ ] `output_format` - 下拉选择（jpeg, png）
    - [ ] `safety_tolerance` - 整数滑块（0-6）
    - [ ] `prompt_upsampling` - 布尔选择
  - [ ] 定义 `RETURN_TYPES`：
    - [ ] `IMAGE` - 生成的图像
    - [ ] `STRING` - 图像URL
    - [ ] `STRING` - 状态信息

- [ ] **3.2 节点功能实现**
  - [ ] 实现主处理函数
  - [ ] 集成API客户端调用
  - [ ] 实现图像下载和格式转换
  - [ ] 将PIL图像转换为ComfyUI张量格式
  - [ ] 添加进度显示和状态反馈
  - [ ] 实现错误处理和用户友好的错误信息

- [ ] **3.3 高级功能节点（可选扩展）**
  - [ ] 创建 `FluxKontextBatchNode` - 批量生成节点
  - [ ] 创建 `FluxKontextAdvancedNode` - 高级参数节点
  - [ ] 支持多图输入功能（URL列表处理）

### 阶段四：工具函数开发
- [ ] **4.1 图像处理工具 (`utils.py`)**
  - [ ] 实现 `download_image()` - 从URL下载图像
  - [ ] 实现 `pil_to_tensor()` - PIL图像转ComfyUI张量
  - [ ] 实现 `tensor_to_pil()` - 张量转PIL图像
  - [ ] 实现 `validate_aspect_ratio()` - 宽高比验证
  - [ ] 实现 `parse_image_urls()` - 多图URL解析

- [ ] **4.2 配置管理工具 (`config.py`)**
  - [ ] 实现API密钥管理
  - [ ] 实现默认参数配置
  - [ ] 实现环境变量读取
  - [ ] 添加配置验证功能

### 阶段五：节点注册和集成
- [ ] **5.1 ComfyUI集成 (`__init__.py`)**
  - [ ] 导入所有节点类
  - [ ] 设置 `NODE_CLASS_MAPPINGS` 字典
  - [ ] 设置 `NODE_DISPLAY_NAME_MAPPINGS` 字典
  - [ ] 添加节点分类信息
  - [ ] 实现动态加载机制

- [ ] **5.2 错误处理和日志**
  - [ ] 实现统一的异常处理
  - [ ] 添加详细的日志记录
  - [ ] 实现用户友好的错误提示
  - [ ] 添加调试模式支持

### 阶段六：测试和优化
- [ ] **6.1 功能测试**
  - [ ] 测试基本图像生成功能
  - [ ] 测试所有参数组合
  - [ ] 测试错误情况处理
  - [ ] 测试网络异常处理
  - [ ] 测试大批量生成性能

- [ ] **6.2 兼容性测试**
  - [ ] 测试不同ComfyUI版本兼容性
  - [ ] 测试不同操作系统兼容性
  - [ ] 测试Python版本兼容性

- [ ] **6.3 性能优化**
  - [ ] 优化图像下载速度
  - [ ] 实现请求缓存机制
  - [ ] 优化内存使用
  - [ ] 添加并发处理支持

### 阶段七：文档和发布
- [ ] **7.1 文档编写**
  - [ ] 完善 `README.md`：
    - [ ] 项目介绍和特性
    - [ ] 安装说明
    - [ ] API密钥获取指南
    - [ ] 使用教程和示例
    - [ ] 参数详细说明
    - [ ] 常见问题解答
    - [ ] 更新日志
  - [ ] 创建使用示例工作流文件
  - [ ] 添加节点使用截图

- [ ] **7.2 代码质量**
  - [ ] 添加代码注释和文档字符串
  - [ ] 代码格式化和规范检查
  - [ ] 添加类型提示
  - [ ] 代码重构和优化

- [ ] **7.3 发布准备**
  - [ ] 创建版本标签
  - [ ] 准备发布说明
  - [ ] 测试安装包
  - [ ] 准备示例文件

### 阶段八：维护和扩展
- [ ] **8.1 功能扩展**
  - [ ] 支持input_image参数（当API支持时）
  - [ ] 添加更多输出格式支持
  - [ ] 实现工作流模板功能
  - [ ] 添加预设参数管理

- [ ] **8.2 社区支持**
  - [ ] 建立问题反馈机制
  - [ ] 创建使用教程视频
  - [ ] 维护用户社区
  - [ ] 定期更新和bug修复

## 开发优先级
1. **高优先级**：阶段一、二、三（核心功能）
2. **中优先级**：阶段四、五、六（完善和测试）
3. **低优先级**：阶段七、八（文档和扩展）

## 预估开发时间
- 核心功能开发：3-5天
- 测试和优化：2-3天
- 文档和发布：1-2天
- 总计：6-10天

## 技术要点
- 严格按照ComfyUI自定义节点开发规范
- 遵循Flux-Kontext API文档规范
- 注重错误处理和用户体验
- 保持代码可维护性和扩展性 